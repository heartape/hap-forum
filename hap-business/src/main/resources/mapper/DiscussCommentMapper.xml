<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heartape.hap.business.mapper.DiscussCommentMapper">

    <resultMap id="commentTree" type="com.heartape.hap.business.entity.DiscussComment">
        <id column="comment_id" property="commentId" />
        <result column="uid" property="uid" />
        <result column="avatar" property="avatar" />
        <result column="nickname" property="nickname" />
        <result column="content" property="content" />
        <result column="created_time" property="createdTime" />
        <collection property="children" ofType="com.heartape.hap.business.entity.DiscussCommentChild">
            <id column="comment_id_child" property="commentId" />
            <result column="uid_child" property="uid" />
            <result column="avatar_child" property="avatar" />
            <result column="nickname_child" property="nickname" />
            <result column="content_child" property="content" />
            <result column="created_time_child" property="createdTime" />
            <result column="child_to_child" property="childToChild" />
            <result column="child_target" property="childTarget" />
            <result column="child_target_name" property="childTargetName" />
        </collection>
    </resultMap>

    <select id="selectTreeList" resultMap="commentTree">
        <bind name="offset" value="(page-1)*size"/>
        select t1.comment_id, t1.uid, t1.avatar, t1.nickname, t1.content, t1.created_time,
        t2.comment_id comment_id_child, t2.uid uid_child, t2.avatar avatar_child, t2.nickname nickname_child,
        t2.content content_child, t2.created_time created_time_child,
        t2.child_to_child, t2.child_target, t2.child_target_name
        from (
        select comment_id, uid, children_id, avatar, nickname, content, created_time
        from discuss_comment
        where discuss_id = #{discuss_id} and status = 1
        limit #{offset}, #{size}) t1
        left join discuss_comment_child t2
        on JSON_CONTAINS(JSON_EXTRACT(t1.children_id, '$[*]'), CONVERT(t2.comment_id, CHAR))
        and t2.status = 1
    </select>
</mapper>
